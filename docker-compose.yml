version: '3.8'

networks:
  public:
    name: public
    external: true

services:
    train:
        deploy:
            replicas: 4
        image: 'registry.rubercubic.com:5001/dqn-orderbook'
        volumes:
            - ${HOME}/.exchange-data/:/home/joliveros/.exchange-data/
        command: bash -c "source ~/.bashrc &&
            ./examples/dqn_orderbook/run.py TLMUSDT -i 42h -D 4 --summary-interval 20 -g 30s -w 2m
            --database-name binance_futures -l 62 -d 50 --leverage 2.0
            --offset-interval 30m --test-interval 4h --nb-steps 16800 -m 200 -s 3 --max-negative-pnl -0.025 --cache"
        environment:
            - LOG_LEVEL=INFO
            - NVIDIA_VISIBLE_DEVICES=all
        networks:
            - public
        depends_on:
            - influxdb
            - redis
        secrets:
            - DB

    eval_agent:
      deploy:
        replicas: 0
      image: 'registry.rubercubic.com:5001/dqn-orderbook'
      volumes:
        - ${HOME}/.exchange-data/:/home/joliveros/.exchange-data/
      command: bash -c "source ~/.bashrc &&
        ./examples/dqn_orderbook/eval_agent.py TLMUSDT --valid-interval 30m -D 4 -l 2 -d 15 -m 120"
      environment:
        - LOG_LEVEL=DEBUG
        - NVIDIA_VISIBLE_DEVICES=all
      networks:
        - public
      depends_on:
        - influxdb
        - redis
      secrets:
        - DB


secrets:
  DB:
      external: true


#./examples/dqn_orderbook/run.py TLMUSDT -i 42h -D 4 --summary-interval 20 -g 30s -w 2m \
#--database-name binance_futures -l 62 -d 50 --leverage 2.0 \
#--offset-interval 30m --test-interval 4h --nb-steps 16800 -m 200 -s 3 --max-negative-pnl -0.025 --cache
